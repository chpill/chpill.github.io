<!DOCTYPE html>
<html><head><title>Rapid feedback webdev (with Reitit)</title><meta charset="utf-8" /><link href="/assets/pandoc-gfm.css" rel="stylesheet" /></head><body><header><nav><p><span style="padding-right:2rem;">Chpill&apos;s (Over) Engineering Log</span><a href="/">about</a> - <a href="/en/posts">posts</a> - <a href="/en/feed.xml">feed</a></p></nav></header><main><h1>Rapid feedback webdev (with Reitit)</h1><p><i>2023-11-18</i></p><p>In the <a
href="/en/posts/getting-a-feel-for-closeables.html">previous post</a>,
we got aquainted with <code>closeables</code> to manage runtime state in
our Clojure programs. It worked like a charm, but it was (purposefully)
very simple. In real world applications, it can be painful to stop and
start a system every time you make a change (for example: if you need to
populate a development database with a lot of data). That's why <a
href="https://github.com/weavejester/integrant/#suspending-and-resuming">Integrant</a>
features a suspend/resume mechanism, to get a kind of "soft reload" of
your system. Obviously, we cannot do that here, but let me share a DIY
trick mentionned in the <a
href="https://cljdoc.org/d/metosin/reitit/0.7.0-alpha7/doc/advanced/dev-workflow">Reitit
documentation</a> that will help keep your feedback loop short as you
are building a website or an api server. We'll then dig a little deeper
into why it works and when it doesn't, so that you may reuse this
pattern outside of webdev as well.</p>
<h2 id="simple-routing-fragments">Simple routing fragments</h2>
<p>For this example, we'll create a bunch of files to mimick a more
complex project structure. The code is available in this <a
href="https://github.com/chpill/demo-closeable/tree/master/meatier-webserver">repository</a>.
First, let's create a namespace where we'll put the incrementing counter
function from the <a
href="/en/posts/getting-a-feel-for-closeables.html">previous
post</a>.</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode clj"><code class="sourceCode clojure"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">ns</span> demo-closeable.deeply-nested)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> real-worldish-function </span>[{<span class="at">:as</span> _req <span class="at">:keys</span> [counter]}]</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  {<span class="at">:status</span> <span class="dv">200</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>   <span class="at">:body</span> (<span class="kw">str</span> <span class="st">&quot;Real-worldish counter: &quot;</span> (<span class="kw">swap!</span> counter <span class="kw">inc</span>))})</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> routes </span>[]</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  [<span class="st">&quot;/counter&quot;</span> real-worldish-function])</span></code></pre></div>
<p>The counter atom is now retrieved through a custom key associated to
the request argument. Notice that we provide a fragment of a Reitit
routing table, but we do it in a seemingly strange way, by wrapping it
in a <code>routes</code> function of no arguments. We'll explain why
later. Let's add another namespace that will require the first one.</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode clj"><code class="sourceCode clojure"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">ns</span> demo-closeable.nested</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  (<span class="at">:require</span> [demo-closeable.deeply-nested <span class="at">:as</span> deeply-nested]))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> routes </span>[]</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  [[<span class="st">&quot;/ping&quot;</span> (<span class="kw">fn</span> [_req] {<span class="at">:status</span> <span class="dv">200</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">:body</span> <span class="st">&quot;nested pong&quot;</span>})]</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>   [<span class="st">&quot;/deeply-nested&quot;</span> (deeply-nested/routes)]])</span></code></pre></div>
<p>Again, the same pattern. The <code>routes</code> function of the
previous namespace is called inside the routing fragment of the current
namespace. Let's go up another level, and create a namespace that will
build the complete routing table.</p>
<h2 id="root-handler">Root handler</h2>
<div class="sourceCode" id="cb3"><pre
class="sourceCode clj"><code class="sourceCode clojure"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">ns</span> demo-closeable.root-handler</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  (<span class="at">:require</span> [demo-closeable.nested <span class="at">:as</span> nested]</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>            [reitit.ring <span class="at">:as</span> rr]))</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> complete-routes </span>[]</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  [<span class="st">&quot;&quot;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>   [<span class="st">&quot;/nested&quot;</span> (nested/routes)]</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>   [<span class="st">&quot;/ping&quot;</span> (<span class="kw">fn</span> [_req] {<span class="at">:status</span> <span class="dv">200</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">:body</span> <span class="st">&quot;pong&quot;</span>})]])</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> inject-counter </span>[counter]</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">fn</span> [handler]</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">fn</span> inject-counter-middleware [req]</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>      (handler (<span class="kw">assoc</span> req <span class="at">:counter</span> counter)))))</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> make </span>[counter]</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  (rr/ring-handler (rr/router (complete-routes))</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>                   (rr/create-default-handler</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>                    {<span class="at">:not-found</span> (<span class="kw">constantly</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>                                 {<span class="at">:status</span> <span class="dv">404</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">:body</span> <span class="st">&quot;Real-worldish 404 page&quot;</span>})})</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>                   {<span class="at">:middleware</span> [(inject-counter counter)]}))</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> make-reloading </span>[&amp; args]</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  (rr/reloading-ring-handler #(<span class="kw">apply</span> make args)))</span></code></pre></div>
<p>Now, we get to more interesting functions:</p>
<ul>
<li><code>complete-routes</code> returns the complete routing table of
the application.</li>
<li><code>inject-counter</code> returns a synchronous ring middleware
that will provide the counter atom to any handler it is applied to.</li>
<li><code>make</code> turns the routing table into a fully fledged
handler, with the previous middleware being applied globally.</li>
<li><code>make-reloading</code> calls a handy development helper from
Reitit: the <a
href="https://github.com/metosin/reitit/blob/620d0c271175a4e11d91d922b26c8162660db3f9/modules/reitit-ring/src/reitit/ring.cljc#L371-L385">reloading-ring-handler</a>.
It will call <code>make</code> to recreate the handler on every
request.</li>
</ul>
<p>Because we have made every routing fragment a function, when
<code>make</code> is called on each request, it in turn call every one
of them, and the resulting complete routing table will contain the last
evaluated value of every <code>routes</code> and leaf handler, however
nested they may be.</p>
<h2 id="the-system">The system</h2>
<p>And now, the entry point of the webserver:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode clj"><code class="sourceCode clojure"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">ns</span> demo-closeable.meatier-webserver</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  (<span class="at">:require</span> [ring.adapter.jetty <span class="at">:refer</span> [run-jetty]]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>            [demo-closeable.root-handler <span class="at">:as</span> handler]))</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> closeable</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  ([value] (closeable value <span class="kw">identity</span>))</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  ([value close]</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">reify</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>     clojure.lang.IDeref (<span class="kw">deref</span> [_] value)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>     java.io.Closeable (close [_] (close value)))))</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> run-with-webserver </span>[config f]</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">with-open</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    [counter (closeable (<span class="kw">atom</span> <span class="dv">42</span>))</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>     handler (closeable ((<span class="kw">if</span> (<span class="at">:dev</span> config)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>                           handler/make-reloading</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>                           handler/make)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>                         <span class="at">@counter</span>))</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>     webserver (closeable (run-jetty <span class="at">@handler</span> {<span class="at">:port</span> (<span class="at">:port</span> config)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">:join</span>? <span class="va">false</span>})</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>                          #(.stop <span class="va">%</span>))]</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    (f <span class="at">@webserver</span>)))</span></code></pre></div>
<p>Compared to the previous post, the only difference here is the
handler, where we check the config to decide which flavor of handler we
want:
<code>(if (:dev config) handler/make-reloading handler/make)</code>. Use
the new config parameter we introduced to launch the server:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode clj"><code class="sourceCode clojure"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>(run-with-webserver {<span class="at">:port</span> <span class="dv">54321</span> <span class="at">:dev</span> <span class="va">true</span>}</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                    #(.<span class="kw">join</span> <span class="va">%</span>))</span></code></pre></div>
<p>Open <a
href="http://localhost:54321/nested/deeply-nested/counter">http://localhost:54321/nested/deeply-nested/counter</a>
in your browser, you should see the new counter page.</p>
<p>Now, try changing and re-evaluating the leaf handlers and the routing
fragments. You'll see that the changes are picked up as soon as you
refresh the page in your browser. For my particular workflow with emacs
and CIDER, that mean I will simply
<code>cider-eval-defun-at-point</code> to re-evaluate the top-level form
I'm currently editing, and then I can refresh the page in a browser for
example.</p>
<p>To verify this behaviour a little more rigorously, we can write a
test like this:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode clj"><code class="sourceCode clojure"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">ns</span> demo-closeable.meatier-webserver-test</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  (<span class="at">:require</span> [clojure.<span class="kw">test</span> <span class="at">:refer</span> [<span class="bu">deftest</span><span class="fu"> is </span><span class="kw">run-tests</span>]]</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>            [demo-closeable.deeply-nested <span class="at">:as</span> dn]</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>            [demo-closeable.meatier-webserver</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">:refer</span> [run-with-webserver]]))</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>(<span class="bu">deftest</span><span class="fu"> test-reloading-webserver</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> [port <span class="dv">12345</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        url (<span class="kw">str</span> <span class="st">&quot;http://localhost:&quot;</span> port</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>                 <span class="st">&quot;/nested/deeply-nested/counter&quot;</span>)]</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    (run-with-webserver</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>     {<span class="at">:port</span> port <span class="at">:dev</span> <span class="va">true</span>}</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">fn</span> [_webserver]</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">is</span> (<span class="kw">=</span> <span class="st">&quot;Real-worldish counter: 43&quot;</span> (<span class="kw">slurp</span> url)))</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">let</span> [original-function-value dn/real-worldish-function]</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">alter-var-root</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>          <span class="va">#&#39;dn/real-worldish-function</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">fn</span> [_f] (<span class="kw">fn</span> [_req] {<span class="at">:status</span> <span class="dv">200</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>                               <span class="at">:body</span> <span class="st">&quot;LOCALLY RELOADED!&quot;</span>})))</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">is</span> (<span class="kw">=</span> <span class="st">&quot;LOCALLY RELOADED!&quot;</span> (<span class="kw">slurp</span> url)))</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">alter-var-root</span> <span class="va">#&#39;dn/real-worldish-function</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>                         (<span class="kw">fn</span> [_f] original-function-value))</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">is</span> (<span class="kw">=</span> <span class="st">&quot;Real-worldish counter: 44&quot;</span> (<span class="kw">slurp</span> url))))))))</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>(<span class="kw">comment</span> (<span class="kw">run-tests</span>))</span></code></pre></div>
<h2 id="where-if-falls-short">Where if falls short</h2>
<p>To dig a little deeper, this works because when clojure functions are
evaluated (which specifically means "compiled" by the Clojure compiler
here), a distinction is made between symbols referencing global <a
href="https://clojure.org/reference/vars">vars</a> and others in the
lexical scope. You can get the full picture by reading about <a
href="https://clojure.org/reference/evaluation">Clojure's
evaluation</a>. When the function is invoked, every var in its body will
be dereferenced (or "traversed"), so you will see the last evaluated
value of those vars (unless you are compiling with <a
href="https://clojuredocs.org/clojure.core/*compiler-options*">direct-linking</a>
enabled, but that's not usually the case during development).</p>
<p>We can observe this difference when the value of a function is
captured in the closure of another. Let's add an example of this to the
<code>deeply-nested</code> namespace:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode clj"><code class="sourceCode clojure"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">ns</span> demo-closeable.deeply-nested)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> real-worldish-function </span>[{<span class="at">:as</span> _req <span class="at">:keys</span> [counter]}]</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  {<span class="at">:status</span> <span class="dv">200</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>   <span class="at">:body</span> (<span class="kw">str</span> <span class="st">&quot;Real-worldish counter: &quot;</span> (<span class="kw">swap!</span> counter <span class="kw">inc</span>))})</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> example-fn </span>[_]</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  {<span class="at">:status</span> <span class="dv">200</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>   <span class="at">:body</span> <span class="st">&quot;Re-evaluate me if you can!&quot;</span>})</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> smug-middleware </span>[handler]</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">fn</span> inner-function [req]</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">update</span> (handler req)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">:body</span> <span class="kw">str</span> <span class="st">&quot; -- Sent from my server. I use Clojure btw.&quot;</span>)))</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> captured-fn </span>(smug-middleware example-fn))</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> routes </span>[]</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  [[<span class="st">&quot;/counter&quot;</span> real-worldish-function]</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>   [<span class="st">&quot;/closure-issue&quot;</span> captured-fn]])</span></code></pre></div>
<p>Here, we "augmented" <code>example-fn</code> using the
<code>smug-middleware</code>, and <code>def</code>ed the result in the
<code>captured-fn</code> var. If you make a change to
<code>example-fn</code> and naively re-evaluate it, you will notice that
the change is not picked up when you visit <a
href="http://lol:54321/nested/deeply-nested/closure-issue">http://lol:54321/nested/deeply-nested/closure-issue</a>.
That is because the <code>example-fn</code> var is not in the body of
the <code>inner-function</code> that was given to the routing fragment.
If you need to convince yourself of this behaviour, try changing the
middleware like so:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode clj"><code class="sourceCode clojure"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> smug-middleware </span>[handler]</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">fn</span> inner-function [req]</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">update</span> (example-fn req)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">:body</span> <span class="kw">str</span> <span class="st">&quot; -- I like hammocks and private jokes.&quot;</span>)))</span></code></pre></div>
<p>Do a full namespace eval, or a full system reload, and then try
changing and evaluating only <code>example-fn</code> again. This time,
the change will be picked up. The indirection of the middleware is still
the same, the only difference is that we did not use the
<code>handler</code> value that was captured in the closure of the
<code>inner-function</code> (which still contains the previous value).
Instead, we directly used the var <code>example-fn</code>, which is
dereferenced on every call of <code>inner-function</code> behind the
scenes. To be more precise, it works because of the <a
href="https://clojure.org/reference/vars#interning">interning of
vars</a>. This is a really important thing to grasp, so be sure to also
check this <a
href="https://clojure.org/guides/repl/enhancing_your_repl_workflow#writing-repl-friendly-programs">section
of the official clojure REPL guide</a>.</p>
<p>(If you are curious in seeing exactly how this plays out in the lower
level code, you can use the <a
href="https://github.com/clojure-goes-fast/clj-java-decompiler">clj-java-decompiler</a>
to compare the 2 functions, but it isn't vital to the point being
made.)</p>
<details>
<summary>Decompiled code</summary>

<p>Here's the first version of the <code>smug-middleware</code>:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode clj"><code class="sourceCode clojure"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">require</span> &#39;[clj-java-decompiler.core <span class="at">:refer</span> [decompile]])</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">-&gt;&gt;</span> (<span class="bu">defn</span><span class="fu"> smug-middleware </span>[handler]</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">fn</span> inner-function [req]</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">update</span> (handler req)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">:body</span> <span class="kw">str</span> <span class="st">&quot; -- Sent from my server. I use Clojure btw.&quot;</span>)))</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>       decompile</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>       <span class="kw">with-out-str</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>       (spit <span class="st">&quot;/tmp/decompiled-original.java&quot;</span>))</span></code></pre></div>
<div class="sourceCode" id="cb10"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Decompiling class: demo_closeable/deeply_nested$smug_middleware</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> demo_closeable</span><span class="op">;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">clojure</span><span class="op">.</span><span class="im">lang</span><span class="op">.*;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">final</span> <span class="kw">class</span> deeply_nested$smug_middleware <span class="kw">extends</span> AFunction</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="bu">Object</span> <span class="fu">invokeStatic</span><span class="op">(</span><span class="dt">final</span> <span class="bu">Object</span> handler<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> deeply_nested$smug_middleware$<span class="fu">inner_function__13650</span><span class="op">(</span>handler<span class="op">);</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Object</span> <span class="fu">invoke</span><span class="op">(</span><span class="dt">final</span> <span class="bu">Object</span> handler<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">invokeStatic</span><span class="op">(</span>handler<span class="op">);</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Decompiling class: demo_closeable/deeply_nested$smug_middleware$inner_function__13650</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> demo_closeable</span><span class="op">;</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">clojure</span><span class="op">.</span><span class="im">lang</span><span class="op">.*;</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">final</span> <span class="kw">class</span> deeply_nested$smug_middleware$inner_function__13650 <span class="kw">extends</span> AFunction</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Object</span> handler<span class="op">;</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> Var __update<span class="op">;</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> Keyword const__1<span class="op">;</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> Var __str<span class="op">;</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> deeply_nested$smug_middleware$<span class="fu">inner_function__13650</span><span class="op">(</span><span class="dt">final</span> <span class="bu">Object</span> handler<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">handler</span> <span class="op">=</span> handler<span class="op">;</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Object</span> <span class="fu">invoke</span><span class="op">(</span><span class="dt">final</span> <span class="bu">Object</span> req<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> IFn fn <span class="op">=</span> <span class="op">(</span>IFn<span class="op">)</span>__update<span class="op">.</span><span class="fu">getRawRoot</span><span class="op">();</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">Object</span> invoke <span class="op">=</span> <span class="op">((</span>IFn<span class="op">)</span><span class="kw">this</span><span class="op">.</span><span class="fu">handler</span><span class="op">).</span><span class="fu">invoke</span><span class="op">(</span>req<span class="op">);</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> Keyword const__1 <span class="op">=</span> const__1<span class="op">;</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">Object</span> rawRoot <span class="op">=</span> __str<span class="op">.</span><span class="fu">getRawRoot</span><span class="op">();</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">String</span> s <span class="op">=</span> <span class="st">&quot; -- Sent from my server. I use Clojure btw.&quot;</span><span class="op">;</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> fn<span class="op">.</span><span class="fu">invoke</span><span class="op">(</span>invoke<span class="op">,</span> const__1<span class="op">,</span> rawRoot<span class="op">,</span> s<span class="op">);</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    <span class="dt">static</span> <span class="op">{</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>        __update <span class="op">=</span> RT<span class="op">.</span><span class="fu">var</span><span class="op">(</span><span class="st">&quot;clojure.core&quot;</span><span class="op">,</span> <span class="st">&quot;update&quot;</span><span class="op">);</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>        const__1 <span class="op">=</span> RT<span class="op">.</span><span class="fu">keyword</span><span class="op">(</span><span class="kw">null</span><span class="op">,</span> <span class="st">&quot;body&quot;</span><span class="op">);</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>        __str <span class="op">=</span> RT<span class="op">.</span><span class="fu">var</span><span class="op">(</span><span class="st">&quot;clojure.core&quot;</span><span class="op">,</span> <span class="st">&quot;str&quot;</span><span class="op">);</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Here's the second version of the <code>smug-middleware</code></p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode clj"><code class="sourceCode clojure"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">-&gt;&gt;</span> (<span class="bu">defn</span><span class="fu"> smug-middleware </span>[handler]</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">fn</span> inner-function [req]</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">update</span> (example-fn req)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">:body</span> <span class="kw">str</span> <span class="st">&quot; -- I like hammocks and private jokes.&quot;</span>)))</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>       decompile</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>       <span class="kw">with-out-str</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>       (spit <span class="st">&quot;/tmp/decompiled-with-modification.java&quot;</span>))</span></code></pre></div>
<div class="sourceCode" id="cb12"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Decompiling class: demo_closeable/deeply_nested$smug_middleware</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> demo_closeable</span><span class="op">;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">clojure</span><span class="op">.</span><span class="im">lang</span><span class="op">.*;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">final</span> <span class="kw">class</span> deeply_nested$smug_middleware <span class="kw">extends</span> AFunction</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="bu">Object</span> <span class="fu">invokeStatic</span><span class="op">(</span><span class="dt">final</span> <span class="bu">Object</span> handler<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> deeply_nested$smug_middleware$<span class="fu">inner_function__13666</span><span class="op">();</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Object</span> <span class="fu">invoke</span><span class="op">(</span><span class="dt">final</span> <span class="bu">Object</span> handler<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">invokeStatic</span><span class="op">(</span>handler<span class="op">);</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Decompiling class: demo_closeable/deeply_nested$smug_middleware$inner_function__13666</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> demo_closeable</span><span class="op">;</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">clojure</span><span class="op">.</span><span class="im">lang</span><span class="op">.*;</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">final</span> <span class="kw">class</span> deeply_nested$smug_middleware$inner_function__13666 <span class="kw">extends</span> AFunction</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> Var __update<span class="op">;</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> Var __ddeeply_nested_example_fn<span class="op">;</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> Keyword const__2<span class="op">;</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> Var __str<span class="op">;</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Object</span> <span class="fu">invoke</span><span class="op">(</span><span class="dt">final</span> <span class="bu">Object</span> req<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> IFn fn <span class="op">=</span> <span class="op">(</span>IFn<span class="op">)</span>__update<span class="op">.</span><span class="fu">getRawRoot</span><span class="op">();</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">Object</span> invoke <span class="op">=</span> __ddeeply_nested_example_fn<span class="op">.</span><span class="fu">invoke</span><span class="op">(</span>req<span class="op">);</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> Keyword const__2 <span class="op">=</span> const__2<span class="op">;</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">Object</span> rawRoot <span class="op">=</span> __str<span class="op">.</span><span class="fu">getRawRoot</span><span class="op">();</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">String</span> s <span class="op">=</span> <span class="st">&quot; -- I like hammocks and private jokes.&quot;</span><span class="op">;</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> fn<span class="op">.</span><span class="fu">invoke</span><span class="op">(</span>invoke<span class="op">,</span> const__2<span class="op">,</span> rawRoot<span class="op">,</span> s<span class="op">);</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>    <span class="dt">static</span> <span class="op">{</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>        __update <span class="op">=</span> RT<span class="op">.</span><span class="fu">var</span><span class="op">(</span><span class="st">&quot;clojure.core&quot;</span><span class="op">,</span> <span class="st">&quot;update&quot;</span><span class="op">);</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>        __ddeeply_nested_example_fn <span class="op">=</span> RT<span class="op">.</span><span class="fu">var</span><span class="op">(</span><span class="st">&quot;demo-closeable.deeply-nested&quot;</span><span class="op">,</span> <span class="st">&quot;example-fn&quot;</span><span class="op">);</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>        const__2 <span class="op">=</span> RT<span class="op">.</span><span class="fu">keyword</span><span class="op">(</span><span class="kw">null</span><span class="op">,</span> <span class="st">&quot;body&quot;</span><span class="op">);</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>        __str <span class="op">=</span> RT<span class="op">.</span><span class="fu">var</span><span class="op">(</span><span class="st">&quot;clojure.core&quot;</span><span class="op">,</span> <span class="st">&quot;str&quot;</span><span class="op">);</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</details>

<p>Thanksfully, you will generally not be bothered by this particular
use case as Reitit provides a more convenient way of applying
middlewares to handlers in the routes data:</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode clj"><code class="sourceCode clojure"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> routes </span>[]</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  [[<span class="st">&quot;/counter&quot;</span> real-worldish-function]</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>   [<span class="st">&quot;/alternative&quot;</span> {<span class="at">:middleware</span> [smug-middleware]}</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    [<span class="st">&quot;&quot;</span> example-fn]]])</span></code></pre></div>
<p>Now, all the vars are once again used directly in the body of the
<code>routes</code> function, so any local re-evaluation will be picked
up as expected. Still, as we tend to use a lot of higher-order
functions, it is frequent to encounter a situation like this one. Often,
we resign ourself to do full system reloads every-time, as we can't be
bothered to check where exactly is the closed over value that is messing
with our REPL workflow. And often, a little change in the code structure
can fix it, and we are left wondering why did we not make that little
change weeks or months ago. The price paid when you extend the duration
of the feedback loop will compound quickly over time. I have been guilty
of doing this too many times, so this post also exists to try to atone
for my past sins. Let's be honest, I'll probably do it again. Shame on
me.</p>
<h2 id="conclusion">Conclusion</h2>
<p>We have illustrated a web project structure that allows for fast
feedback without full system reloads. The structure should also be very
easy to extend upon, adding new routes, handlers, or pieces of runtime
state.</p>
<p>Vars are the unsung heroes of rapid-feedback worklow when doing
Clojure. They are a lower level abstraction compared to a full
"reloaded" workflow (Stuart Halloway gives a good comparison in his talk
<a
href="https://www.youtube.com/watch?v=Qx0-pViyIDU&amp;t=1799s">Running
With Scissors</a>). Although what this post showed was specific to
Reitit, the only <a
href="https://github.com/metosin/reitit/blob/620d0c271175a4e11d91d922b26c8162660db3f9/modules/reitit-ring/src/reitit/ring.cljc#L371-L385">helper
from the library we used</a> is dead simple. This can probably be
replicated with any routing library out there without altering the
structure too much.</p>
</main><footer style="margin-top:3rem;text-align:center;"><hr /><p><small>Made with <a href="https://pandoc.org/">Pandoc</a></small></p></footer></body></html>